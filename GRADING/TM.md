---
Изменено:
  - 20-10-2025, 21:12
Дата создания: 20-10-2025, 21:12
---
# TM — Модель угроз (Consolidated, RU)
Версия: 1.1 • Дата: 2025-10-20 • Владелец: Security/Architecture

## 1) Область и обзор системы
Цель: сервисы **Аутентификации/Сброса пароля (S1)**, **Импорта CSV (S2)** и **Экспорта CSV/JSON (S3)** за API‑шлюзом (**A**), с хранилищем (**D: PostgreSQL/объектное**), интеграциями SMTP (**X**) и внешним Analytics API (**Y**). Разделены границы доверия: Интернет ↔ Сервис, Сервис ↔ Внешние провайдеры, Сервис ↔ Хранилища.

### 1.1 DFD (Mermaid)
```mermaid
flowchart LR
  %% --- Trust boundaries ---
  subgraph Internet["Интернет / Внешние пользователи"]
    U["[U] Пользователь / Браузер / Мобильный клиент"]
  end

  subgraph Service["Основное приложение"]
    A["[A] API Gateway / Controller"]
    S1["[S1] Auth Service (Password Reset)"]
    S2["[S2] Import Service (CSV Upload)"]
    S3["[S3] Export Service (CSV/JSON)"]
    D["[D] PostgreSQL / Object Storage"]
  end

  subgraph External["Внешние сервисы"]
    X["[X] SMTP / Email API"]
    Y["[Y] Analytics / External API"]
  end

  %% --- Потоки данных ---
  U -- "POST /api/auth/forgot, /reset [NFR: Security-Secrets, API-Errors]" --> A
  U -- "POST /api/import/csv [NFR: InputValidation, Data-Integrity]" --> A
  U -- "GET /api/export?format=csv|json [NFR: Privacy/PII, RateLimiting]" --> A

  A -->|"DTO / Requests"| S1
  A -->|"CSV payload"| S2
  A -->|"Query params"| S3

  S1 -->|"Token SHA-256 [NFR: Secrets]"| D
  S1 -->|"Send reset email [NFR: Privacy]"| X
  X -->|"Email to user"| U

  S2 -->|"Validated data → DB [NFR: Integrity]"| D
  S3 -->|"Select & Format [NFR: Performance]"| D
  S3 -->|"HTTP/gRPC call [NFR: Timeouts]"| Y

  S2 -->|"Audit Import [NFR: Audit]"| D
  S3 -->|"Audit Export [NFR: Audit]"| D

  %% --- Границы доверия ---
  classDef boundary fill:#f6f6f6,stroke:#999,stroke-width:1px;
  class Internet,Service,External boundary;

### 1.2 Диаграмма контекста (Mermaid)
```mermaid
graph TD
  U[Users/Admins] -->|HTTPS| A[API Gateway]
  A -->|RBAC| S3[Export Service]
  A -->|Validation| S2[Import Service]
  A -->|Reset Flow| S1[Auth/Reset Service]
  S1 -->|Hash(token), Audit| D[(DB/Storage)]
  S2 -->|Validated rows| D
  S3 -->|Read/Mask| D
  S1 -->|Email reset| X[SMTP]
  S3 -->|Optional calls| Y[Analytics API]
```

## 2) Активы и цели безопасности
- **Учётные данные и токены сброса** — конфиденциальность, целостность, одноразовость.
- **Наборы клиентских данных/PII** — конфиденциальность, минимизация, законность обработки (GDPR/152‑ФЗ).
- **Доступность сервисов импорта/экспорта** — соблюдение SLO.
- **Операционные логи/аудит** — структурированные, без секретов/PII, трассировка по `correlation_id`.

## 3) Зоны доверия
1) Интернет ↔ Сервис (U↔A) — публичные API, загрузка/выгрузка файлов.  
2) Сервис ↔ Внешние (A↔X/Y) — почта/3rd‑party API.  
3) Сервис ↔ Хранилища (S*↔D) — БД/объектное, политики жизненного цикла.

## 4) STRIDE 

| Категория | Пример в контексте | Основная защита |
|---|---|---|
| S (Spoofing) | Подделка запросов, фишинговые ссылки сброса | Подписанные ссылки, единый ответ на неизвестный email, rate‑limit |
| T (Tampering) | Вредоносный CSV (формульная инъекция, схема) | MIME/размер, белый список схемы, нормализация, защита формул |
| R (Repudiation) | Отказ от факта импорта/экспорта/сброса | Аудит, неизменяемые логи, `correlation_id` |
| I (Information Disclosure) | Утечка PII при экспорте/в логах | RBAC `include_pii`, маскирование, запрет секретов в логах |
| D (Denial of Service) | Массовые импорты/экспорты, тяжелые запросы | Rate‑limit, очереди/воркеры, таймауты |
| E (Elevation of Privilege) | Обход ролей при экспорте | Централизованный RBAC, проверка на шлюзе и в сервисе |

## 5) Реестр рисков (топ)
| ID       | Риск                                       | L (вер.) | I (влияние) | E (экспозиция) | S (чувств.) | F/O (частота / обнаруж.) | Обоснование                                                                                                                                                                                                                   |
| -------- | ------------------------------------------ | :------: | :---------: | :------------: | :---------: | :----------------------: | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **R-04** | **Tampering при импорте CSV**              |    H     |      H      |       H        |      M      |          H / L           | Импорт — массовая операция, CSV-файлы часто из внешних источников. Возможна подмена данных, формульные инъекции в Excel, XSS при просмотре. Обнаружение сложно до этапа обработки. Требуется строгая валидация, MIME и схема. |
| **R-03** | **Утечка PII при экспорте**                |    M     |      C      |       M        |      H      |          M / M           | Экспорт содержит потенциально конфиденциальные поля (ФИО, email, телефон, ИНН). Ошибки ролей (`include_pii`) или дефолтных параметров приводят к массовой утечке. Обнаружить утечку можно только ретроспективно по SIEM.      |
| **R-05** | **Фишинг/злоупотребление письмами сброса** |    M     |      H      |       H        |      H      |          H / M           | Письма сброса рассылаются во внешнюю среду, возможна подмена URL/доменов. Пользователи уязвимы к фишингу. Часто, но относительно легко отслеживается по аномалиям в логах.                                                    |
| **R-01** | **Утечка токенов в логах**                 |    L     |      H      |       M        |      H      |          L / H           | Токен — высокочувствительный артефакт (доступ к аккаунту). Ошибки форматирования логов или verbose-режим в debug могут случайно вывести токен. Легко предотвратить, но сложно отследить задним числом.                        |
| **R-02** | **DoS массовыми импортами/экспортами**     |    M     |      M      |       H        |      L      |          H / M           | Большой объём данных или частые запросы могут исчерпать ресурсы (I/O, CPU). Возможен намеренный DoS. Обнаруживается метриками, но требует лимитов и очередей.                                                                 |

[## 6) Контроли (NFR, выдержки)
**US‑003 Сброс пароля**: энтропия ≥ 128 бит, TTL ≤ 15 мин, одноразово; хранить SHA‑256 хэш; унифицированный ответ; ошибки RFC7807; аудит (время/ip/user_id/correlation_id); лимит ≤5/час на IP/email; почтовые политики SPF/DKIM/DMARC; HSTS.  
**US‑013 Импорт CSV**: ≤10 MiB; MIME allowlist; жёсткая схема (лишние колонки — reject); нормализация (UTC ISO‑8601, NFC, E.164); защита формул; журнал jobId; RFC7807; RBAC (manager/admin).  
**US‑014 Экспорт CSV/JSON**: по умолчанию **без PII**; `include_pii=true` только `admin|dpo`; маскирование; retention 7–30 дней; лимиты/таймауты; RFC7807; owner‑only; аудит/метрики.

## 7) Принятые решения (ADR)
- **ADR (R‑04):** Валидация импорта и лимиты — шлюз: размер/MIME; S2: белый список схемы; нормализация; защита от CSV‑инъекций; RFC7807.
- **ADR (R‑03):** Ролевой фильтр PII при экспорте — `include_pii` только для админов/уполномоченных; маскирование; lifecycle S3 ≤30д; аудит; feature‑flag.
- **ADR (R‑05):** Подписанные HTTPS‑ссылки сброса + почтовые политики — HMAC‑подпись, TTL ≤15м, одноразово; DMARC/SPF/DKIM(+BIMI); rate‑limit /forgot; HSTS; без внешних редиректов.](<Отлично 
Вот переработанные разделы **6 (Контроли / NFR)** и **7 (ADR)** по твоим критериям:

Каждый **NFR** теперь в формате *Given–When–Then* и привязан к угрозе (STRIDE / риск).
Каждый **ADR** оформлен как *Decision / DoD / Owner*, с коротким *Trade-off* и перечислением компонентов.
Покрыты **Top-5 рисков (R-04, R-03, R-05, R-01, R-02)**.

---

## ⚙️ 6) Контроли (NFR, выдержки в формате G-W-T)

###  R-04 — Tampering при импорте CSV

**NFR-013-1 — Валидация и размер файла**

%3E **Given**: пользователь загружает CSV через `/import/csv`
> **When**: MIME или размер превышает лимит (10 MiB, `text/csv`/`application/csv`)
> **Then**: система возвращает `400` с RFC 7807-ответом и записью в аудит

**NFR-013-2 — Строгая схема и нормализация**

> **Given**: CSV проходит загрузку
> **When**: встречаются неизвестные колонки, некорректные типы или формульные ячейки
> **Then**: файл отклоняется, фиксируется причина; данные не доходят до хранилища

---

### R-03 — Утечка PII при экспорте

**NFR-014-1 — Ролевое управление флагом `include_pii`**

> **Given**: запрос `/export` с параметром `include_pii=true`
> **When**: роль ≠ `admin|dpo`
> **Then**: возвращается `403` с сообщением «PII export forbidden»

**NFR-014-2 — Маскирование и срок хранения**

> **Given**: экспорт инициирован с разрешением на PII
> **When**: формируются файлы с полями email/phone/ИНН
> **Then**: поля маскируются по шаблону, файлы автоматически удаляются ≤ 7 дней

---

### R-05 — Фишинг и злоупотребления письмами сброса

**NFR-003-1 — Одноразовый HMAC-токен сброса**

> **Given**: пользователь запрашивает сброс
> **When**: токен создаётся и сохраняется
> **Then**: токен имеет TTL ≤ 15 мин, одноразовый, подписан HMAC, хранится как хэш

**NFR-003-2 — Политики почтовой доставки и ограничение частоты**

> **Given**: 6-я попытка сброса с одного IP/email
> **When**: превышен лимит (≤ 5 в час)
> **Then**: возвращается `429`; письмо не отправляется; фиксируется событие для SIEM

---

### R-01 — Утечка токенов в логах

**NFR-003-4 — Маскирование секретов**

> **Given**: сервис пишет структурированный лог
> **When**: обнаружен ключ `token|secret|password`
> **Then**: значение заменяется `***` перед отправкой в лог-агрегатор

---

### R-02 — DoS массовыми импортами/экспортами

**NFR-013-5 / NFR-014-2 — Rate limit и очередь заданий**

> **Given**: клиент отправляет > N (например 10) параллельных импортов/экспортов
> **When**: лимит превышен
> **Then**: возвращается `429 Retry-After`, задача ставится в очередь; метрика фиксируется

---

## 7) Принятые решения (ADR)

| ID          | Decision                                                                                     | DoD (Definition of Done)                                                          | Owner                                                                          | Trade-offs                                           | Затронутые компоненты                         |                    |
| ----------- | -------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------- | ------------------------------------------------------------------------------ | ---------------------------------------------------- | --------------------------------------------- | ------------------ |
| **ADR-R04** | **“Input Sanitization & Size Limit”** — импорты принимаются только при соблюдении MIME/схемы | лимиты проверяются на API;  unit-тесты `sanitize_csv`;  e2e импорт > 10 MiB → 400 | Команда S2                                                                     | Безопасно; Увеличено время загрузки больших файлов   | Gateway, S2, Storage                          |                    |
| **ADR-R03** | **“Role-Based PII Export”** — доступ к PII только `admin                                     | dpo`                                                                              | флаг `include_pii` требует роль;  маскирование тестируется;  lifecycle ≤ 7 дн. | Команда S3 / DPO                                     | Минимизирует утечки; Доп. логика ролей/флагов | Gateway, S3, DB/S3 |
| **ADR-R05** | **“Signed Reset Link + Mail Policy”** — сброс через HMAC-ссылку и доверенные SMTP            | TTL ≤ 15 мин;  письмо без PII;  DKIM/SPF/DMARC тесты                              | Команда S1 / Security                                                          | Защита от фишинга;  Сложнее отладка внешней почты    | S1, SMTP, Gateway                             |                    |
| **ADR-R01** | **“Structured Logging with Masking”** — внедрение фильтра логов                              | тест `no_token_in_logs`;  json-логгер обновлён;  SIEM rule активен                | Команда Core Ops                                                               | Исключает утечки;  Скрывает часть данных для отладки | Все сервисы                                   |                    |
| **ADR-R02** | **“Async Queue & Rate Limiter”** — все экспорты/импорты через очередь                        |  установлен rate-limit;  нагрузочный тест %3C 80% CPU                             | Команда Platform                                                               | Снижение DoS; Добавлена задержка для фоновых задач   | Gateway, S2, S3                               |                    |

---

Хочешь, чтобы я вставила эти обновлённые разделы **6–7** прямо в твой `TM.md` (заменив старые)?
Могу также добавить после них короткий **сводный список Threat→NFR→ADR→Owner**, чтобы отслеживать ответственных по каждому риску.>)
## 8) Трассировка Threat → NFR → ADR → Тесты
| Threat/Risk | NFR | ADR/Политика | Evidence/Тесты |
|---|---|---|---|
| CSV tampering (R‑04) | NFR‑013‑1/2 | ADR R‑04 | e2e: `import-size-check`, `schema-extra-cols`; unit: `normalize-fields`, `sanitize-formulas` |
| PII export leak (R‑03) | NFR‑014‑1 | ADR R‑03 | e2e: `export_pii_access_test`; unit: `mask_pii_fields`; lifecycle policy |
| Phishing reset (R‑05) | NFR‑003‑1/2/6 | ADR R‑05 | e2e: `email-template-check`, `reset-limit-test`; unit: `token-hmac-verify` |
| Tokens in logs (R‑01) | NFR‑003‑4/7 | Политика mask/strip | Лог‑скан по сигнатурам секретов; JSON‑структура |
| DoS import/export (R‑02) | NFR‑013‑5, NFR‑014‑2 | Rate‑limit + Queue | Нагрузочные тесты; 429 + Retry‑After |

## 9) Тестирование, наблюдаемость, соответствие
- **Контракт ошибок:** RFC7807 с `correlation_id` во всех сервисах.
- **Аудит:** события импорта/экспорта/сброса, правила SIEM для аномалий.
- **Приватность:** экспорт без PII по умолчанию; маскирование; короткий retention.
- **Доступность/SLO:** ≥99.5% для критичных путей (reset/export); целевые perf‑SLO.
- **Почта:** SPF/DKIM/DMARC (p=reject), опц. BIMI.
- **Метрики:** таймеры и счётчики отказов/отбрасываний; дэшборды.

## 10) Открытые вопросы
- Политика обработки ячеек, похожих на формулы: экранировать vs. отклонять файл при порогах.
- Детализация маскировки по полям (пример: телефоны — последние 4 цифры).
- Применение lifecycle к выгрузкам внешней аналитики.
- Коды для просроченных/повторно использованных токенов (410 vs 409).

## 11) Приложения (артефакты)
- DFD — `S04_dfd.md`
- STRIDE‑матрица — `S04_stride_matrix.md`
- Оценка рисков — `S04_risk_scoring.md`
- Реестр NFR — `S03_register.md`
- ADR и Option‑матрицы — `S05_*`](<Хорошо. Ниже — полностью обновлённая версия **TM.md (на русском)** без эмодзи, с учётом всех улучшений:

* улучшенный **реестр рисков** с факторами (экспозиция, чувствительность, частота/обнаружимость);
* **контроли (NFR)** в формате *Given–When–Then*;
* **принятые решения (ADR)** в формате *Decision / DoD / Owner / Trade-offs / Components*;
* сохранены разделы DFD, контекст, STRIDE, трассировка и приложения.

---

# TM — Модель угроз

Версия: 1.2 • Дата: 2025-10-12 • Владелец: Security/Architecture

## 1) Область и обзор системы

Цель: сервисы **Аутентификации/Сброса пароля (S1)**, **Импорта CSV (S2)** и **Экспорта CSV/JSON (S3)** за API-шлюзом (**A**), с хранилищем (**D: PostgreSQL/объектное**), интеграциями SMTP (**X**) и внешним Analytics API (**Y**).
Разделены границы доверия: Интернет ↔ Сервис, Сервис ↔ Внешние провайдеры, Сервис ↔ Хранилища.

### 1.1 DFD (Mermaid)

```mermaid
flowchart LR
  subgraph Internet [Интернет / Клиентская зона]
    U[Пользователь / Клиент]
  end

  subgraph Core [Сервисная зона]
    A[API Gateway / Controller]
    S1[Сервис S1: Сброс пароля]
    S2[Сервис S2: Импорт CSV]
    S3[Сервис S3: Экспорт CSV/JSON]
    D[(Хранилище D: БД / Объектное)]
  end

  subgraph External [Внешние провайдеры]
    X[SMTP / Почтовый сервис]
    Y[Analytics API (опционально)]
  end

  U --%3E|POST /auth/forgot| A
  U -->|POST /auth/reset| A
  U -->|POST /import/csv| A
  U -->|GET /export?format=csv|json| A

  A --> S1
  A --> S2
  A --> S3

  S1 %3C--> D
  S2 --> D
  S3 <--> D

  S1 -->|Письмо сброса| X
  S3 -->|Опционально| Y

  A -. audit/logs .-> D
  S2 -. import-job logs .-> D
  S3 -. export-job logs .-> D
```

### 1.2 Диаграмма контекста (Mermaid)

```mermaid
graph TD
  U[Users/Admins] -->|HTTPS| A[API Gateway]
  A -->|RBAC| S3[Export Service]
  A -->|Validation| S2[Import Service]
  A -->|Reset Flow| S1[Auth/Reset Service]
  S1 -->|Hash(token), Audit| D[(DB/Storage)]
  S2 -->|Validated rows| D
  S3 -->|Read/Mask| D
  S1 -->|Email reset| X[SMTP]
  S3 -->|Optional calls| Y[Analytics API]
```

## 2) Активы и цели безопасности

* Учётные данные и токены сброса — конфиденциальность, целостность, одноразовость.
* Наборы клиентских данных (PII) — конфиденциальность, минимизация, законность обработки.
* Доступность сервисов импорта/экспорта — соблюдение SLA/SLO.
* Операционные логи — структурированные, без секретов и PII, трассировка по `correlation_id`.

## 3) Границы доверия

1. Интернет ↔ Сервис (U↔A) — публичные API, загрузка и выгрузка файлов.
2. Сервис ↔ Внешние (A↔X/Y) — почта и внешние API.
3. Сервис ↔ Хранилища (S*↔D) — база данных и объектное хранилище.

## 4) STRIDE (сводка)

| Категория                  | Пример угрозы                               | Основная защита                                              |
| -------------------------- | ------------------------------------------- | ------------------------------------------------------------ |
| S (Spoofing)               | Подделка запросов, фишинговые ссылки сброса | Подписанные ссылки, унифицированные ответы, rate-limit       |
| T (Tampering)              | Вредоносный CSV, изменение структуры данных | MIME/размер, белый список схемы, нормализация, защита формул |
| R (Repudiation)            | Отказ от факта импорта/экспорта             | Аудит, логи, `correlation_id`                                |
| I (Information Disclosure) | Утечка PII при экспорте                     | RBAC `include_pii`, маскирование, аудит                      |
| D (Denial of Service)      | Массовые запросы, нагрузка на сервис        | Rate-limit, очередь, таймауты                                |
| E (Elevation of Privilege) | Обход ролей при экспорте                    | Централизованный RBAC, проверки на шлюзе и в сервисах        |

## 5) Реестр рисков (топ)

| ID   | Риск                                     |  L  |  I  | E (экспозиция) | S (чувств.) | F/O (частота / обнаруж.) | Обоснование                                                                                                                      |
| ---- | ---------------------------------------- | :-: | :-: | :------------: | :---------: | :----------------------: | -------------------------------------------------------------------------------------------------------------------------------- |
| R-04 | Tampering при импорте CSV                |  H  |  H  |        H       |      M      |           H / L          | Импорт — массовая операция, часто внешние CSV. Возможна подмена данных или инъекции формул. Обнаружение до обработки затруднено. |
| R-03 | Утечка PII при экспорте                  |  M  |  C  |        M       |      H      |           M / M          | Ошибки ролей или флага `include_pii` приводят к утечкам персональных данных. Контроль осуществляется только постфактум.          |
| R-05 | Фишинг и злоупотребления письмами сброса |  M  |  H  |        H       |      H      |           H / M          | Почтовые ссылки могут быть подделаны или перехвачены. Пользователи уязвимы к фишингу. Отслеживается через SIEM.                  |
| R-01 | Утечка токенов в логах                   |  L  |  H  |        M       |      H      |           L / H          | Возможна при отладке или verbose-режимах. Токен — чувствительный артефакт доступа.                                               |
| R-02 | DoS массовыми импортами/экспортами       |  M  |  M  |        H       |      L      |           H / M          | Большой объём задач блокирует воркеры. Обнаруживается метриками, требует лимитов.                                                |

## 6) Контроли (NFR, Given–When–Then)

### R-04 — Tampering при импорте CSV

**NFR-013-1 — Валидация и размер файла**
Given: пользователь загружает CSV через `/import/csv`
When: MIME или размер превышает лимит (10 MiB, `text/csv`, `application/csv`)
Then: система возвращает `400` с RFC7807 и записью в аудит

**NFR-013-2 — Строгая схема и нормализация**
Given: CSV проходит загрузку
When: встречаются неизвестные колонки, формульные ячейки или некорректные типы
Then: файл отклоняется, фиксируется причина, данные не сохраняются

### R-03 — Утечка PII при экспорте

**NFR-014-1 — Ролевое управление `include_pii`**
Given: запрос `/export` с `include_pii=true`
When: роль ≠ `admin|dpo`
Then: возвращается `403` и событие фиксируется в аудит

**NFR-014-2 — Маскирование и срок хранения**
Given: экспорт разрешён
When: формируются файлы с полями email/phone/ИНН
Then: данные маскируются, файлы удаляются ≤7 дней

### R-05 — Фишинг при сбросе

**NFR-003-1 — Одноразовый HMAC-токен**
Given: пользователь запрашивает сброс
When: создаётся токен
Then: TTL ≤15 мин, одноразовый, хранится как SHA-256 хэш

**NFR-003-2 — Ограничение частоты сброса**
Given: 6-я попытка с одного IP/email
When: превышен лимит (≤5 в час)
Then: возвращается `429`, письмо не отправляется, создаётся запись в SIEM

### R-01 — Утечка токенов в логах

**NFR-003-4 — Маскирование секретов**
Given: сервис пишет лог
When: обнаружен ключ `token|secret|password`
Then: значение заменяется `***` перед записью

### R-02 — DoS массовыми задачами

**NFR-013-5 / NFR-014-2 — Rate limit и очередь**
Given: клиент отправляет >N параллельных импортов/экспортов
When: лимит превышен
Then: возвращается `429 Retry-After`, задача ставится в очередь

## 7) Принятые решения (ADR)

| ID      | Decision                                                                               | DoD (Definition of Done)                                                      | Owner                | Trade-offs                                            | Затронутые компоненты |
| ------- | -------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------- | -------------------- | ----------------------------------------------------- | --------------------- |
| ADR-R04 | Input Sanitization & Size Limit — импорты принимаются только при соблюдении MIME/схемы | лимиты проверяются на API; unit-тесты `sanitize_csv`; e2e импорт >10MiB → 400 | Команда S2           | Безопасно, но увеличено время загрузки больших файлов | Gateway, S2, Storage  |
| ADR-R03 | Role-Based PII Export — доступ к PII только admin/dpo                                  | проверка флага, маскирование, lifecycle ≤7дн                                  | Команда S3, DPO      | Минимизация утечек, но усложнение ролей               | Gateway, S3, DB/S3    |
| ADR-R05 | Signed Reset Link + Mail Policy — HMAC-ссылка, TTL ≤15мин, DMARC/SPF/DKIM              | проверены TTL, шаблон письма без PII                                          | Команда S1, Security | Сильная защита, но сложнее отладка SMTP               | S1, SMTP, Gateway     |
| ADR-R01 | Structured Logging with Masking — фильтр логов                                         | тест `no_token_in_logs`, обновлён json-логгер                                 | Core Ops             | Исключает утечки, но скрывает часть отладочных данных | Все сервисы           |
| ADR-R02 | Async Queue & Rate Limiter — импорт/экспорт через очередь                              | установлен rate-limit, нагрузочный тест <80% CPU                              | Platform Team        | Устойчивость к DoS, но небольшая задержка задач       | Gateway, S2, S3       |

## 8) Трассировка Threat → NFR → ADR → Тесты

| Threat/Risk              | NFR                  | ADR/Политика | Тесты/Доказательства                                   |
| ------------------------ | -------------------- | ------------ | ------------------------------------------------------ |
| CSV tampering (R-04)     | NFR-013-1/2          | ADR-R04      | e2e: `import-size-check`, unit: `sanitize-formulas`    |
| PII export leak (R-03)   | NFR-014-1/2          | ADR-R03      | e2e: `export_pii_access_test`, unit: `mask_pii_fields` |
| Phishing reset (R-05)    | NFR-003-1/2          | ADR-R05      | e2e: `email-template-check`, unit: `token-hmac-verify` |
| Token in logs (R-01)     | NFR-003-4            | ADR-R01      | unit: `no_token_in_logs`, SIEM check                   |
| DoS import/export (R-02) | NFR-013-5, NFR-014-2 | ADR-R02      | load tests, 429 с Retry-After                          |

## 9) Тестирование, наблюдаемость и соответствие

* Контракт ошибок: RFC7807 с `correlation_id`.
* Аудит: события импорта/экспорта/сброса фиксируются и анализируются в SIEM.
* Приватность: экспорт без PII по умолчанию; retention ≤7–30 дней.
* Доступность: SLO ≥99.5% для критичных функций.
* Почтовая безопасность: SPF/DKIM/DMARC (p=reject), BIMI.
* Метрики: таймеры, счётчики ошибок, лимиты нагрузки.

## 10) Открытые вопросы

* Обработка ячеек, похожих на формулы: экранировать или отклонять.
* Детализация маскировки по полям (например, последние 4 цифры телефона).
* Применение lifecycle к аналитическим выгрузкам.
* Коды ответов для просроченных токенов (410 vs 409).

## 11) Приложения

* S04_dfd.md — диаграмма потоков данных
* S04_stride_matrix.md — STRIDE
* S04_risk_scoring.md — оценка рисков
* S03_register.md — реестр NFR
* S05_* — ADR и Option Matrix

---

Хочешь, чтобы я сохранила этот итоговый вариант как новый **TM.md**-файл (с заменой текущего в проекте)?>)](<Хорошо. Ниже — полностью обновлённая версия **TM.md (на русском)** без эмодзи, с учётом всех улучшений:

* улучшенный **реестр рисков** с факторами (экспозиция, чувствительность, частота/обнаружимость);
* **контроли (NFR)** в формате *Given–When–Then*;
* **принятые решения (ADR)** в формате *Decision / DoD / Owner / Trade-offs / Components*;
* сохранены разделы DFD, контекст, STRIDE, трассировка и приложения.

---

# TM — Модель угроз

Версия: 1.2 • Дата: 2025-10-12 • Владелец: Security/Architecture

## 1) Область и обзор системы

Цель: сервисы **Аутентификации/Сброса пароля (S1)**, **Импорта CSV (S2)** и **Экспорта CSV/JSON (S3)** за API-шлюзом (**A**), с хранилищем (**D: PostgreSQL/объектное**), интеграциями SMTP (**X**) и внешним Analytics API (**Y**).
Разделены границы доверия: Интернет ↔ Сервис, Сервис ↔ Внешние провайдеры, Сервис ↔ Хранилища.

### 1.1 DFD (Mermaid)

```mermaid
flowchart LR
  subgraph Internet [Интернет / Клиентская зона]
    U[Пользователь / Клиент]
  end

  subgraph Core [Сервисная зона]
    A[API Gateway / Controller]
    S1[Сервис S1: Сброс пароля]
    S2[Сервис S2: Импорт CSV]
    S3[Сервис S3: Экспорт CSV/JSON]
    D[(Хранилище D: БД / Объектное)]
  end

  subgraph External [Внешние провайдеры]
    X[SMTP / Почтовый сервис]
    Y[Analytics API (опционально)]
  end

  U --%3E|POST /auth/forgot| A
  U -->|POST /auth/reset| A
  U -->|POST /import/csv| A
  U -->|GET /export?format=csv|json| A

  A --> S1
  A --> S2
  A --> S3

  S1 %3C--> D
  S2 --> D
  S3 <--> D

  S1 -->|Письмо сброса| X
  S3 -->|Опционально| Y

  A -. audit/logs .-> D
  S2 -. import-job logs .-> D
  S3 -. export-job logs .-> D
```

### 1.2 Диаграмма контекста (Mermaid)

```mermaid
graph TD
  U[Users/Admins] -->|HTTPS| A[API Gateway]
  A -->|RBAC| S3[Export Service]
  A -->|Validation| S2[Import Service]
  A -->|Reset Flow| S1[Auth/Reset Service]
  S1 -->|Hash(token), Audit| D[(DB/Storage)]
  S2 -->|Validated rows| D
  S3 -->|Read/Mask| D
  S1 -->|Email reset| X[SMTP]
  S3 -->|Optional calls| Y[Analytics API]
```

## 2) Активы и цели безопасности

* Учётные данные и токены сброса — конфиденциальность, целостность, одноразовость.
* Наборы клиентских данных (PII) — конфиденциальность, минимизация, законность обработки.
* Доступность сервисов импорта/экспорта — соблюдение SLA/SLO.
* Операционные логи — структурированные, без секретов и PII, трассировка по `correlation_id`.

## 3) Границы доверия

1. Интернет ↔ Сервис (U↔A) — публичные API, загрузка и выгрузка файлов.
2. Сервис ↔ Внешние (A↔X/Y) — почта и внешние API.
3. Сервис ↔ Хранилища (S*↔D) — база данных и объектное хранилище.

## 4) STRIDE (сводка)

| Категория                  | Пример угрозы                               | Основная защита                                              |
| -------------------------- | ------------------------------------------- | ------------------------------------------------------------ |
| S (Spoofing)               | Подделка запросов, фишинговые ссылки сброса | Подписанные ссылки, унифицированные ответы, rate-limit       |
| T (Tampering)              | Вредоносный CSV, изменение структуры данных | MIME/размер, белый список схемы, нормализация, защита формул |
| R (Repudiation)            | Отказ от факта импорта/экспорта             | Аудит, логи, `correlation_id`                                |
| I (Information Disclosure) | Утечка PII при экспорте                     | RBAC `include_pii`, маскирование, аудит                      |
| D (Denial of Service)      | Массовые запросы, нагрузка на сервис        | Rate-limit, очередь, таймауты                                |
| E (Elevation of Privilege) | Обход ролей при экспорте                    | Централизованный RBAC, проверки на шлюзе и в сервисах        |

## 5) Реестр рисков (топ)

| ID   | Риск                                     |  L  |  I  | E (экспозиция) | S (чувств.) | F/O (частота / обнаруж.) | Обоснование                                                                                                                      |
| ---- | ---------------------------------------- | :-: | :-: | :------------: | :---------: | :----------------------: | -------------------------------------------------------------------------------------------------------------------------------- |
| R-04 | Tampering при импорте CSV                |  H  |  H  |        H       |      M      |           H / L          | Импорт — массовая операция, часто внешние CSV. Возможна подмена данных или инъекции формул. Обнаружение до обработки затруднено. |
| R-03 | Утечка PII при экспорте                  |  M  |  C  |        M       |      H      |           M / M          | Ошибки ролей или флага `include_pii` приводят к утечкам персональных данных. Контроль осуществляется только постфактум.          |
| R-05 | Фишинг и злоупотребления письмами сброса |  M  |  H  |        H       |      H      |           H / M          | Почтовые ссылки могут быть подделаны или перехвачены. Пользователи уязвимы к фишингу. Отслеживается через SIEM.                  |
| R-01 | Утечка токенов в логах                   |  L  |  H  |        M       |      H      |           L / H          | Возможна при отладке или verbose-режимах. Токен — чувствительный артефакт доступа.                                               |
| R-02 | DoS массовыми импортами/экспортами       |  M  |  M  |        H       |      L      |           H / M          | Большой объём задач блокирует воркеры. Обнаруживается метриками, требует лимитов.                                                |

## 6) Контроли (NFR, Given–When–Then)

### R-04 — Tampering при импорте CSV

**NFR-013-1 — Валидация и размер файла**
Given: пользователь загружает CSV через `/import/csv`
When: MIME или размер превышает лимит (10 MiB, `text/csv`, `application/csv`)
Then: система возвращает `400` с RFC7807 и записью в аудит

**NFR-013-2 — Строгая схема и нормализация**
Given: CSV проходит загрузку
When: встречаются неизвестные колонки, формульные ячейки или некорректные типы
Then: файл отклоняется, фиксируется причина, данные не сохраняются

### R-03 — Утечка PII при экспорте

**NFR-014-1 — Ролевое управление `include_pii`**
Given: запрос `/export` с `include_pii=true`
When: роль ≠ `admin|dpo`
Then: возвращается `403` и событие фиксируется в аудит

**NFR-014-2 — Маскирование и срок хранения**
Given: экспорт разрешён
When: формируются файлы с полями email/phone/ИНН
Then: данные маскируются, файлы удаляются ≤7 дней

### R-05 — Фишинг при сбросе

**NFR-003-1 — Одноразовый HMAC-токен**
Given: пользователь запрашивает сброс
When: создаётся токен
Then: TTL ≤15 мин, одноразовый, хранится как SHA-256 хэш

**NFR-003-2 — Ограничение частоты сброса**
Given: 6-я попытка с одного IP/email
When: превышен лимит (≤5 в час)
Then: возвращается `429`, письмо не отправляется, создаётся запись в SIEM

### R-01 — Утечка токенов в логах

**NFR-003-4 — Маскирование секретов**
Given: сервис пишет лог
When: обнаружен ключ `token|secret|password`
Then: значение заменяется `***` перед записью

### R-02 — DoS массовыми задачами

**NFR-013-5 / NFR-014-2 — Rate limit и очередь**
Given: клиент отправляет >N параллельных импортов/экспортов
When: лимит превышен
Then: возвращается `429 Retry-After`, задача ставится в очередь

## 7) Принятые решения (ADR)

| ID      | Decision                                                                               | DoD (Definition of Done)                                                      | Owner                | Trade-offs                                            | Затронутые компоненты |
| ------- | -------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------- | -------------------- | ----------------------------------------------------- | --------------------- |
| ADR-R04 | Input Sanitization & Size Limit — импорты принимаются только при соблюдении MIME/схемы | лимиты проверяются на API; unit-тесты `sanitize_csv`; e2e импорт >10MiB → 400 | Команда S2           | Безопасно, но увеличено время загрузки больших файлов | Gateway, S2, Storage  |
| ADR-R03 | Role-Based PII Export — доступ к PII только admin/dpo                                  | проверка флага, маскирование, lifecycle ≤7дн                                  | Команда S3, DPO      | Минимизация утечек, но усложнение ролей               | Gateway, S3, DB/S3    |
| ADR-R05 | Signed Reset Link + Mail Policy — HMAC-ссылка, TTL ≤15мин, DMARC/SPF/DKIM              | проверены TTL, шаблон письма без PII                                          | Команда S1, Security | Сильная защита, но сложнее отладка SMTP               | S1, SMTP, Gateway     |
| ADR-R01 | Structured Logging with Masking — фильтр логов                                         | тест `no_token_in_logs`, обновлён json-логгер                                 | Core Ops             | Исключает утечки, но скрывает часть отладочных данных | Все сервисы           |
| ADR-R02 | Async Queue & Rate Limiter — импорт/экспорт через очередь                              | установлен rate-limit, нагрузочный тест <80% CPU                              | Platform Team        | Устойчивость к DoS, но небольшая задержка задач       | Gateway, S2, S3       |

## 8) Трассировка Threat → NFR → ADR → Тесты

| Threat/Risk              | NFR                  | ADR/Политика | Тесты/Доказательства                                   |
| ------------------------ | -------------------- | ------------ | ------------------------------------------------------ |
| CSV tampering (R-04)     | NFR-013-1/2          | ADR-R04      | e2e: `import-size-check`, unit: `sanitize-formulas`    |
| PII export leak (R-03)   | NFR-014-1/2          | ADR-R03      | e2e: `export_pii_access_test`, unit: `mask_pii_fields` |
| Phishing reset (R-05)    | NFR-003-1/2          | ADR-R05      | e2e: `email-template-check`, unit: `token-hmac-verify` |
| Token in logs (R-01)     | NFR-003-4            | ADR-R01      | unit: `no_token_in_logs`, SIEM check                   |
| DoS import/export (R-02) | NFR-013-5, NFR-014-2 | ADR-R02      | load tests, 429 с Retry-After                          |

## 9) Тестирование, наблюдаемость и соответствие

* Контракт ошибок: RFC7807 с `correlation_id`.
* Аудит: события импорта/экспорта/сброса фиксируются и анализируются в SIEM.
* Приватность: экспорт без PII по умолчанию; retention ≤7–30 дней.
* Доступность: SLO ≥99.5% для критичных функций.
* Почтовая безопасность: SPF/DKIM/DMARC (p=reject), BIMI.
* Метрики: таймеры, счётчики ошибок, лимиты нагрузки.

## 10) Открытые вопросы

* Обработка ячеек, похожих на формулы: экранировать или отклонять.
* Детализация маскировки по полям (например, последние 4 цифры телефона).
* Применение lifecycle к аналитическим выгрузкам.
* Коды ответов для просроченных токенов (410 vs 409).

## 11) Приложения

* S04_dfd.md — диаграмма потоков данных
* S04_stride_matrix.md — STRIDE
* S04_risk_scoring.md — оценка рисков
* S03_register.md — реестр NFR
* S05_* — ADR и Option Matrix

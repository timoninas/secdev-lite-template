# S05 - Матрица вариантов (Option Matrix)

## 1) Контекст риска (из S04)

* **Risk-ID:** `R-05 (Фишинговые письма сброса пароля — высокая частота и тяжёлые последствия)`     **Threat:** `I`
* **DFD element/edge:** `X --> U, U --> A, A --> S1, S1 --> D`
* **NFR link (ID):** `NFR-003-1, NFR-003-2, NFR-003-6`
* **L×I (1-5):** `L=3, I=5, Score=15`
* **Ограничения/предпосылки:** Собственный домен для отправки, необходимо защитить пользователей от фишинговых писем со сбросом пароля

## 2) Таблица сравнения вариантов

| Alternative | Summary (1-2 фразы)           | Security impact (↑,1-5) | Blast radius reduction (↑,1-5) | Complexity (↓,1-5) | Time-to-mitigate (↓,1-5) | Dependencies (↓,1-5) | **Benefit** | **Cost** | **Net** | Notes |
| ----------- |-------------------------------|------------------------:|-------------------------------:|-------------------:|-------------------------:|---------------------:|------------:|---------:|--------:| ----- |
| A           | Signed HTTP link with TTL     |                       4 |                              3 |                  2 |                        2 |                    2 |           7 |        6 |       1 |       |
| B           | Linkless code as OTP with TTL |                       5 |                              4 |                  4 |                        3 |                    2 |           9 |        9 |       0 |       |

---

## 3) Решение (для переноса в ADR)

* **Chosen alternative:** `<A>`
* **Почему:** Вариант A дешевле хоть и предоставляет меньший уровень защиты. Не сильно влияет на флоу юзера, требует минимальных изменений UX
* **ADR candidate (название):** `Signed HTTP link with TTL  `
* **Связки:** Risk-ID `R-05`, NFR-ID `NFR-003-1, NFR-003-2, NFR-003-6`, DFD `X --> U, U --> A, A --> S1, S1 --> D`
* **Следующие шаги (минимум):**
  1. Добавление токена сброса — ≥128 бит, TTL ≤15 мин, одноразовый, хранится в виде SHA-256 хэша
  2. Подписанная ссылка формата: https://accounts.domain/reset?token={JTI}&sig={HMAC-SHA-256}, с проверкой домена на whitelist
  3. Оставляем только ссылку в письме со сбросом 
  4. Ставим Rate Limit, не более 5 запросов на сброс/час с одного IP или email

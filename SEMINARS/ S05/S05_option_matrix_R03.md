
---

## 1) Контекст риска

**Risk-ID:** `R-03 (Export / S3 — утечка персональных данных)` **Threat:** `I (Information Disclosure)`
- **DFD element/edge:** `U → A → S3 → D`
- **NFR link (ID):** `NFR-014-1 (Privacy / PII Handling)`
- **L×I (1-5):** `L=3, I=5, Score=15`
- **Ограничения/предпосылки:** Экспорт выполняет `[S3] Export Service`, получает данные из `[D] PostgreSQL / Object Storage`, выдаёт pre-signed URL; необходимо соблюдение 152-ФЗ и GDPR.

---

## 1) Критерии и шкалы (1-5)

**Польза (↑):**

- **Security impact:** насколько альтернатива предотвращает/снижает риск утечки.
- **Blast radius reduction:** насколько уменьшает масштаб последствий (по ролям, арендаторам, фичам).

**Стоимость/сложность (↓):**

- **Complexity:** трудоёмкость реализации (код/конфиги/тесты).
- **Time-to-mitigate:** время до эффекта (в спринтах).
- **Dependencies:** внешние зависимости (другие команды, миграции, API).


## 2) Таблица сравнения вариантов

|Alternative|Summary (1-2 фразы)|Security impact (↑,1-5)|Blast radius reduction (↑,1-5)|Complexity (↓,1-5)|Time-to-mitigate (↓,1-5)|Dependencies (↓,1-5)|**Benefit**|**Cost**|**Net**|Notes|
|---|---|--:|--:|--:|--:|--:|--:|--:|--:|---|
|**A**|Глобальное маскирование PII в DB-view (уровень [D])|5|5|4|4|4|**10**|**12**|**−2**|Максимальная изоляция, но требует миграции всех сервисов и ломает аналитику|
|**B**|Post-processing утилита очистки PII после экспорта|3|3|3|3|3|**6**|**9**|**−3**|Простое внедрение, но остаётся окно утечки до момента очистки|
|**C**|Ролевой фильтр + маскирование при экспорте (уровень [S3])|4|5|2|2|2|**9**|**6**|**+3**|Локальная реализация без внешних зависимостей, быстрый эффект|

## 3) Тай-брейкеры при равенстве Net

- **Compliance/Privacy:** вариант C напрямую удовлетворяет 152-ФЗ / GDPR (Privacy by Design).
- **Maintainability:** фильтры на уровне сервиса проще сопровождать, чем централизованные DB-view.
- **Team fit:** у команды уже есть опыт с RBAC и S3 lifecycle-политиками.
- **Observability:** добавляются audit-логи без PII.
- **Rollback safety:** можно безопасно откатить фича-флагом.


## 4) Решение

- **Chosen alternative:** `C — Ролевой фильтр + маскирование при экспорте (S3)`
- **Почему:** обеспечивает наибольший баланс пользы и стоимости: быстро внедряется, снижает риск массовой утечки, соответствует NFR-014-1 и требованиям комплаенса.
- **ADR candidate (название):** `Role-Based PII Filter for Export Service (S3)`
- **Связки:** Risk-ID `R-03`, NFR-ID `NFR-014-1`, DFD `U → A → S3 → D`
- **Следующие шаги:**
    1. Реализовать проверку ролей (`admin`, `dpo`) при `include_pii=true`.
    2. Добавить маскирование ключевых PII-полей при `include_pii=false`.
    3. Настроить S3 Lifecycle Rule — удаление файлов ≤ 30 дней.
    4. Логировать `actor_role`, `include_pii`, `export_id`, `file_key` (без PII).
    5. Добавить e2e и unit-тесты: `export_pii_access_test`, `mask_pii_fields`.

## 5) Самопроверка

- [ ] Риск и контекст из S03 указаны.
- [ ] Сравнено 3 альтернативы.
- [ ] Заполнены все критерии (1-5) и рассчитаны Benefit/Cost/Net.
- [ ] Добавлены тай-брейкеры и выбор с обоснованием.
- [ ] кандидат готов (`Role-Based PII Filter for Export Service (S3)`).


